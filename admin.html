<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>çœ‹æ¿å…§å®¹ç®¡ç†ç³»çµ±</title>
    <style>
        body { font-family: sans-serif; padding: 30px; background: #f4f7f6; color: #333; }
        .admin-box { max-width: 600px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { border-bottom: 2px solid #003366; padding-bottom: 10px; color: #003366; }
        .item { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { background: #003366; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px; }
        button:hover { background: #0055a3; }
        #preview { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .thumb { width: 80px; height: 50px; object-fit: cover; border-radius: 4px; }
        .img-list { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .img-item { display: flex; flex-direction: column; align-items: center; }
        .img-item label { font-weight: normal; margin-top: 2px; font-size: 13px; }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
    <div class="admin-box">
        <h2>ğŸ¥ çœ‹æ¿å…§å®¹ç®¡ç†</h2>
        <div class="item">
            <label>YouTube å½±ç‰‡ä»£ç¢¼ (ID)</label>
            <input type="text" id="ytId" placeholder="ä¾‹å¦‚: m_dhMSvUCIc">
        </div>
        <div class="item">
            <label>è·‘é¦¬ç‡ˆå…¬å‘Šæ–‡å­—</label>
            <textarea id="mqText" rows="3"></textarea>
        </div>
        <div class="item">
            <label>é¸æ“‡è³‡æ–™å¤¾ç¾æœ‰åœ–ç‰‡ï¼ˆå¯å¤šé¸ï¼‰</label>
            <div id="imgList" class="img-list"></div>
        </div>
        <div class="item">
            <label>æ–°å¢å¹»ç‡ˆç‰‡ç…§ç‰‡ä¸Šå‚³</label>
            <input type="file" id="photoInput" accept="image/*" multiple>
            <div id="preview"></div>
        </div>
        <button onclick="save()">å„²å­˜è¨­å®šä¸¦åŒæ­¥çœ‹æ¿</button>
    </div>

    <script>
        // Firebase è¨­å®š
        const firebaseConfig = {
          apiKey: "AIzaSyC_aT7nwS5PNGo67EB2tJrRjKW4gIElWps",
          authDomain: "pttv-1ef51.firebaseapp.com",
          projectId: "pttv-1ef51",
          storageBucket: "pttv-1ef51.firebasestorage.app",
          messagingSenderId: "590206250055",
          appId: "1:590206250055:web:96ec186f39689ca973d562"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // åˆå§‹åŒ–è¼‰å…¥
        db.ref('ytId').once('value', snap => {
            document.getElementById('ytId').value = snap.val() || 'm_dhMSvUCIc';
        });
        db.ref('mqText').once('value', snap => {
            document.getElementById('mqText').value = snap.val() || 'ğŸ˜· è«‹é…æˆ´å£ç½©ä¸¦å‹¤æ´—æ‰‹ï¼Œä¿è­·ä½ æˆ‘å¥åº·ï¼';
        });

        // é¡¯ç¤ºè³‡æ–™å¤¾ç¾æœ‰åœ–ç‰‡èˆ‡å·²ä¸Šå‚³åœ–ç‰‡
        const allFiles = ["photo1.jpg", "photo2.jpg"];
        db.ref('photoFiles').once('value', snap => {
            const selectedFiles = snap.val() || [];
            const imgList = document.getElementById('imgList');
            // è³‡æ–™å¤¾åœ–ç‰‡
            allFiles.forEach(f => {
                const div = document.createElement('div');
                div.className = 'img-item';
                div.innerHTML = `<img src="${f}" class="thumb"><label><input type="checkbox" value="${f}" ${selectedFiles.includes(f) ? 'checked' : ''}>${f}</label>`;
                imgList.appendChild(div);
            });
            // Firebase ä¸Šå‚³åœ–ç‰‡
            db.ref('photos').once('value', snap2 => {
                const savedPhotos = snap2.val() || [];
                savedPhotos.forEach((src, idx) => {
                    const key = `firebase_${idx}`;
                    const div = document.createElement('div');
                    div.className = 'img-item';
                    div.innerHTML = `<img src="${src}" class="thumb"><label><input type="checkbox" value="${src}" ${selectedFiles.includes(src) ? 'checked' : ''}>ä¸Šå‚³åœ–${idx+1}</label>
                    <button type="button" style="margin-top:4px;font-size:12px;" onclick="deletePhoto(${idx})">åˆªé™¤</button>`;
                    imgList.appendChild(div);
                });
            });
        });

        // é è¦½å·²ä¸Šå‚³çš„åœ–ç‰‡
        const preview = document.getElementById('preview');
        db.ref('photos').once('value', snap => {
            const savedPhotos = snap.val() || [];
            savedPhotos.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                img.className = 'thumb';
                preview.appendChild(img);
            });
        });

        // åœ–ç‰‡å£“ç¸®å·¥å…·
        function compressImage(file, maxWidth = 1024, quality = 0.7) {
            return new Promise(resolve => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = e => {
                    img.onload = () => {
                        const scale = Math.min(1, maxWidth / img.width);
                        const w = img.width * scale;
                        const h = img.height * scale;
                        const canvas = document.createElement('canvas');
                        canvas.width = w;
                        canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('photoInput').addEventListener('change', function() {
            preview.innerHTML = '';
            Array.from(this.files).forEach(file => {
                compressImage(file).then(base64 => {
                    const img = document.createElement('img');
                    img.src = base64;
                    img.className = 'thumb';
                    preview.appendChild(img);
                });
            });
        });

        async function save() {
            try {
                await db.ref('ytId').set(document.getElementById('ytId').value);
                await db.ref('mqText').set(document.getElementById('mqText').value);

                // å„²å­˜é¸æ“‡çš„ç¾æœ‰åœ–ç‰‡
                const imgList = document.getElementById('imgList');
                const checked = Array.from(imgList.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value);
                await db.ref('photoFiles').set(checked);

                // å„²å­˜ä¸Šå‚³çš„åœ–ç‰‡ï¼ˆå£“ç¸®å¾Œï¼‰
                const files = document.getElementById('photoInput').files;
                if (files.length > 0) {
                    const photoPromises = Array.from(files).map(file => compressImage(file));
                    const base64Photos = await Promise.all(photoPromises);
                    await db.ref('photos').set(base64Photos);
                }
                alert('è¨­å®šæˆåŠŸï¼è«‹åˆ·æ–°çœ‹æ¿é é¢æŸ¥çœ‹æ•ˆæœã€‚');
            } catch (err) {
                alert('å„²å­˜å¤±æ•—ï¼š' + (err && err.message ? err.message : err));
                console.error('å„²å­˜å¤±æ•—', err);
            }
        }
        // åˆªé™¤ä¸Šå‚³åœ–ç‰‡
        window.deletePhoto = async function(idx) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åœ–ç‰‡ï¼Ÿ')) return;
            const snap = await db.ref('photos').once('value');
            let arr = snap.val() || [];
            arr.splice(idx, 1);
            await db.ref('photos').set(arr);
            location.reload();
        }
    </script>
</body>
</html>
